#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "libattopng.h"
#include "bb_gl.h"
#include "bb_graph_png.h"

#define BB_GRAPH_PNG_BP 4                   // Bytes per pixel.
#define BB_GRAPH_PNG_LP 2

#define BB_GRAPH_PNG_LINE_W 1.0f
#define BB_GRAPH_PNG_LINE_WW (BB_GRAPH_PNG_LINE_W * BB_GRAPH_PNG_LINE_W)

#define BB_GRAPH_PNG_SW 5
#define BB_GRAPH_PNG_SH 5

#define BB_GRAPH_PNG_ERRS_N 11              // Number of errors.

struct bb_graph_png {                       // png-data.
    libattopng_t *png;                      // png-descriptor.
    char *r;                                // Rotate data.
    unsigned char *buf;                     // Buffer for drawing lines.
    size_t buf_size;                        // Size of buffer for drawing lines.
    int w;                                  // Width.
    int h;                                  // Height.
    int wh;                                 // Width * Height.
};

struct bb_paste_image {                     // Data for paste (text-)image.
    char *i_start;                          // Image start.
    int to_start;                           // Text offset start.
    int i_string;                           // Image string length.
    int i_step;                             // Step for image.
    int t_step;                             // Step for text.
    char *i_stop;                           // Image stop.
};

static const unsigned char BB_G_WB_COLOR[3] = {BB_G_WB_R, BB_G_WB_G, BB_G_WB_B};
static const unsigned char BB_G_WS_COLOR[3] = {BB_G_WS_R, BB_G_WS_G, BB_G_WS_B};
static const unsigned char BB_G_LB_COLOR[3] = {BB_G_LB_R, BB_G_LB_G, BB_G_LB_B};
static const unsigned char BB_G_LS_COLOR[3] = {BB_G_LS_R, BB_G_LS_G, BB_G_LS_B};

unsigned char BB_GL[BB_GL_WH * BB_GL_N] = { 255, 253, 169,  41,   4,  38, 163, 252, 255, 255, 186,   9,  31, 107,  34,   7, 
                                            177, 255, 255,  71,   2, 199, 255, 209,   2,  61, 254, 234,  25,  32, 255, 255, 
                                            255,  46,  19, 225, 207,   8,  75, 240, 184, 239,  87,   4, 199, 197,   3,  88, 
                                            119,   1, 110,  96,   0, 191, 199,   4,  87, 158,  31, 153,  95,   0, 193, 213, 
                                             11,  67, 253, 238, 252,  80,   6, 204, 243,  30,  18, 252, 255, 254,  28,  25, 
                                            235, 255,  98,   1, 154, 252, 165,   1,  86, 255, 255, 216,  32,   9,  35,  10, 
                                             28, 210, 255, 255, 255, 218, 109,  81, 106, 214, 254, 255, 255, 195, 125,  75, 
                                             51, 135, 255, 255, 255, 255,  58,   3,  16,   0, 105, 255, 255, 255, 255, 173, 
                                            191, 166,   0, 105, 255, 255, 255, 255, 255, 255, 186,   0, 105, 255, 255, 255, 
                                            255, 255, 255, 186,   0, 105, 255, 255, 255, 255, 255, 255, 186,   0, 105, 255, 
                                            255, 255, 255, 255, 255, 186,   0, 105, 255, 255, 255, 255, 255, 255, 186,   0, 
                                            105, 255, 255, 255, 255, 255, 255, 186,   0, 105, 255, 255, 255, 255, 232, 215, 
                                            157,   0,  88, 215, 221, 255, 255, 118,  11,   8,   0,   4,  11,  47, 255, 255, 
                                            176, 115, 115, 115, 115, 115, 137, 255, 252, 158,  66,   9,   4,  47, 162, 251, 
                                            255, 244,  32,  22,  74,  87,  22,   5, 156, 255, 247, 149, 230, 255, 255, 199, 
                                              2,  46, 254, 255, 255, 255, 255, 255, 252,   2,  33, 250, 255, 255, 255, 255, 
                                            255, 185,   2,  85, 255, 255, 255, 255, 255, 235,  47,  14, 203, 255, 255, 255, 
                                            255, 241,  70,   3, 159, 254, 255, 255, 255, 248,  90,   5, 130, 253, 255, 255, 
                                            255, 250, 111,   1, 118, 251, 255, 255, 255, 251, 118,   1,  78, 210, 215, 215, 
                                            218, 251, 231,  23,   0,   8,  11,  11,  11,  35, 234, 241, 127, 115, 115, 115, 
                                            115, 115, 128, 243, 255, 139,  60,  12,   3,  40, 150, 249, 255, 255,  62,  36, 
                                             82,  91,  29,   4, 140, 255, 255, 217, 248, 255, 255, 223,   4,  40, 253, 255, 
                                            255, 255, 255, 255, 247,   9,  35, 250, 255, 255, 238, 172, 161,  80,   3, 122, 
                                            255, 255, 255, 202,   0,   0,   0,  59, 239, 255, 255, 255, 240, 178, 169,  95, 
                                              1,  93, 253, 255, 255, 255, 255, 255, 251,  55,  15, 218, 255, 255, 255, 255, 
                                            255, 255,  81,   5, 201, 227, 137, 210, 245, 244, 183,   9,  27, 234, 217,  14, 
                                             11,  31,  30,   7,   9, 150, 254, 247, 175, 109,  82,  79, 104, 196, 253, 255, 
                                            255, 255, 255, 255, 224,  62,  52, 217, 255, 255, 255, 255, 252,  91,   0,   3, 
                                            209, 255, 255, 255, 255, 178,  13,  18,   3, 209, 255, 255, 255, 241,  33,  83, 
                                             78,   3, 209, 255, 255, 253, 116,  18, 213,  79,   3, 209, 255, 255, 198,  11, 
                                            126, 254,  79,   3, 209, 255, 243,  55,  36, 246, 255,  79,   3, 209, 255, 185, 
                                              3,  42,  85,  85,  27,   2,  71, 145, 185,  19,  18,  18,  18,   5,   0,  15, 
                                            104, 255, 255, 255, 255, 255,  79,   3, 209, 255, 255, 255, 255, 255, 255,  79, 
                                              3, 209, 255, 255, 255, 255, 255, 255, 161, 116, 230, 255, 255, 153,  51,  51, 
                                             51,  51,  51, 164, 255, 255, 128,   0,  30,  40,  40,  40, 160, 255, 255, 128, 
                                              0, 191, 255, 255, 255, 255, 255, 255, 128,   0, 174, 222, 243, 255, 255, 255, 
                                            255, 128,   0,  17,  16,  30, 128, 245, 255, 255, 130,  58, 106,  99,  25,   0, 
                                            118, 255, 255, 244, 254, 255, 255, 228,  17,  22, 230, 255, 255, 255, 255, 255, 
                                            255,  80,   4, 200, 255, 255, 255, 255, 255, 255,  66,   7, 206, 244, 144, 212, 
                                            246, 241, 162,   2,  45, 246, 240,  30,  12,  31,  29,   5,  18, 180, 255, 251, 
                                            166, 100,  79,  81, 114, 212, 254, 255, 255, 254, 192,  64,   8,   6,  65, 212, 
                                            255, 255, 190,  15,  15,  76,  87,  31, 180, 255, 252,  60,   5, 195, 254, 255, 
                                            239, 237, 255, 213,  12,  87, 247, 223, 237, 255, 255, 255, 185,   1,  82,  45, 
                                             17,  26, 110, 242, 255, 170,   2,   4,  63, 130,  61,   0, 120, 255, 171,   1, 
                                             34, 249, 255, 246,  18,  30, 242, 185,   1,  90, 255, 255, 255,  65,  15, 220, 
                                            211,  11,  81, 255, 255, 255,  53,  19, 225, 251,  53,  10, 208, 254, 202,   4, 
                                             50, 251, 255, 180,  13,  17,  39,  16,  11, 174, 255, 255, 254, 198, 101,  79, 
                                             99, 196, 254, 255, 198,  51,  51,  51,  51,  51,  51,  71, 239, 196,  41,  40, 
                                             40,  40,  32,   1,  51, 251, 255, 255, 255, 255, 255, 157,   0, 141, 255, 255, 
                                            255, 255, 255, 248,  59,  16, 225, 255, 255, 255, 255, 255, 203,   6,  83, 252, 
                                            255, 255, 255, 255, 255, 111,   1, 176, 255, 255, 255, 255, 255, 235,  26,  26, 
                                            250, 255, 255, 255, 255, 255, 162,   2, 116, 255, 255, 255, 255, 255, 255,  64, 
                                              9, 202, 255, 255, 255, 255, 255, 214,   2,  59, 252, 255, 255, 255, 255, 254, 
                                            118,   0, 151, 255, 255, 255, 255, 255, 251, 144, 119, 235, 255, 255, 255, 255, 
                                            255, 239, 116,  21,   2,  27, 130, 245, 255, 254,  97,   0,  65, 119,  54,   2, 
                                            121, 255, 237,  27,  20, 246, 255, 237,   5,  36, 251, 236,  26,  33, 254, 255, 
                                            251,  10,  36, 250, 254, 102,   4, 133, 193, 114,   4, 128, 255, 255, 231,  44, 
                                              1,   3,   1,  61, 241, 255, 249,  73,   4, 117, 163, 104,   1,  95, 253, 202, 
                                              6,  76, 254, 255, 252,  53,  15, 218, 186,   0, 100, 255, 255, 255,  83,   4, 
                                            199, 212,  11,  32, 226, 254, 217,  17,  22, 229, 253, 106,   4,  21,  40,  18, 
                                              6, 132, 254, 255, 248, 167,  92,  78,  96, 180, 251, 255, 255, 237, 111,  18, 
                                              4,  45, 169, 253, 255, 253,  89,   0,  69, 113,  33,   8, 182, 255, 216,  13, 
                                             49, 249, 255, 213,   3,  69, 255, 189,   0, 103, 255, 255, 255,  33,  26, 236, 
                                            192,   1,  99, 255, 255, 254,  26,  10, 211, 223,  18,  36, 244, 255, 193,   2, 
                                              5, 201, 255, 115,   0,  30,  68,  10,   8,   6, 204, 255, 246, 149,  60,  51, 
                                            124,  73,  18, 223, 255, 255, 255, 255, 255, 246,  21,  42, 250, 255, 200, 210, 
                                            248, 230, 100,   0, 138, 255, 255, 130,  13,  32,  23,   1,  72, 240, 255, 255, 
                                            215, 117,  79,  89, 148, 243, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 240, 229, 238, 255, 255, 255, 255, 255, 255, 103,   6,  95, 255, 
                                            255, 255, 255, 255, 255, 101,   0,  93, 255, 255, 255, 255, 255, 255, 173, 115, 
                                            167, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 178, 104, 104, 104, 
                                            151, 255, 255, 255, 255, 136,  25,  25,  25,  93, 255, 255, 255, 255, 243, 233, 
                                            233, 233, 240, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 221, 176, 200, 251, 255, 255, 255, 255, 190,  25,  16,  11, 119, 253, 255, 
                                            255, 255,  70,  60, 216, 131,  15, 216, 255, 255, 255,  51,  98, 254, 182,   8, 
                                            201, 255, 253, 244, 139,  11,  67,  25,  59, 232, 176,  78,  91, 248, 152,  87, 
                                             86, 101,  41,  27, 119, 209, 243, 177,  80,  14,  69,  93, 113, 171, 248, 176, 
                                             39, 118, 215, 133,  11,  33,  12, 118, 246, 242, 255, 247,  35, 106, 251, 128, 
                                              8, 255, 255, 255, 247,  35, 104, 250, 127,   7, 255, 255, 255, 255, 136,  11, 
                                             32,  11, 114, 255, 255, 255, 255, 250, 181, 122, 173, 248};

unsigned char BB_GP[BB_GP_WH] = {   249, 111,  17,  17, 111, 249, 111,   0,   0,   0,   0, 111, 
                                     17,   0,   0,   0,   0,  17,  17,   0,   0,   0,   0,  18, 
                                    111,   0,   0,   0,   0, 111, 249, 111,  17,  18, 111, 249};

unsigned char BB_GT[BB_GT_WH * BB_GT_N] = { 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 247,  63,  54, 243, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 229,  25,  83, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 246,  55,  46, 242, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  71, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 205, 202, 252, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  71, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                             92, 123, 255, 255, 255, 255, 255, 209,  89, 172, 252,  92,  90,  90, 114, 246, 
                                            255, 255, 255, 203,  89, 150,  99,  37,  62, 188, 254, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  55, 111,  37,  61, 167, 253, 255, 250, 112, 
                                            117, 255, 255, 245, 114, 125, 251, 187,  89, 174, 255, 255, 255, 217,  93, 142, 
                                             57,  28, 244, 255, 255, 255, 255, 146,   1, 178, 251,  61,  52,  12,  44, 242, 
                                            255, 255, 255, 178,   0,   8,  37,  63,   7,  27, 231, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,   1,  20,  79,  22,   7, 173, 254, 248,  29, 
                                             38, 255, 255, 240,  33,  54, 250, 224,  11,  60, 254, 255, 254, 130,   2, 164, 
                                            113,   8, 204, 248, 194, 220, 255,  89,   8, 230, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0,  51, 244, 254, 119,   1, 173, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  11, 200, 255, 206,  16,  55, 249, 248,  29, 
                                             38, 255, 255, 240,  33,  54, 250, 255,  81,   8, 208, 255, 250,  40,  29, 236, 
                                            176,   2, 162, 202,   7,  84, 245,  45,  54, 247, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 120, 255, 255, 164,   0, 143, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  55, 249, 255, 253,  53,   6, 236, 248,  29, 
                                             38, 255, 255, 240,  33,  54, 250, 255, 179,   3, 121, 254, 193,   2, 109, 255, 
                                            217,  15, 104, 138,   0,  22, 208,  13, 100, 254, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  68, 255, 255, 255,  75,   4, 224, 248,  29, 
                                             38, 255, 255, 240,  33,  54, 250, 255, 240,  38,  37, 244, 102,   3, 201, 255, 
                                            251,  42,  56,  66,  75,   9, 119,   2, 164, 255, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  63, 253, 255, 255,  64,   3, 232, 248,  30, 
                                             38, 254, 255, 237,  28,  54, 250, 255, 255, 127,   1, 159,  28,  59, 248, 255, 
                                            255, 100,   8,   9, 168,  56,  16,   8, 214, 255, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,  29, 232, 255, 236,  33,  31, 244, 249,  46, 
                                             32, 240, 255, 213,   6,  54, 250, 255, 255, 218,   7,  29,   2, 147, 255, 255, 
                                            255, 154,   1,  21, 227, 122,   1,  26, 252, 255, 201, 160, 155,  35,  29, 153, 
                                            160, 197, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 227,  10,   1,  88, 173,  91,   1, 118, 254, 254,  93, 
                                              3, 111, 166,  60,   1,  54, 250, 255, 255, 251,  72,   0,  11, 232, 255, 255, 
                                            255, 216,  17,  76, 253, 193,  17,  97, 255, 255, 125,  14,  14,  14,  14,  14, 
                                             14, 111, 255, 183,  14, 143, 255, 255, 173,  14, 147, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 229,  24,  39,  32,   2,   7,  82, 241, 255, 255, 211, 
                                             36,   2,   5,  68,  34,  64, 250, 255, 255, 255, 160,   0,  87, 255, 255, 255, 
                                            255, 251, 222, 234, 255, 250, 221, 236, 255, 255, 236, 220, 220, 220, 220, 220, 
                                            220, 234, 255, 245, 220, 239, 255, 255, 244, 220, 240, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 251, 222, 231, 230, 196, 209, 248, 255, 255, 255, 255, 
                                            233, 196, 207, 245, 225, 227, 254, 255, 255, 254, 112,   3, 180, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 188, 153,  14,  47, 243, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 204, 173, 173, 173, 173, 
                                            173, 173, 173, 173, 185, 250, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255,  34,   2,  28, 186, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 154,  93,  93,  93,  93, 
                                             93,  93,  93,  93, 115, 246, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 203, 196, 230, 254, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 247,  63,  54, 243, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 239,  13,   0,   0,  37, 244, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 246,  55,  46, 242, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 248, 140, 131,  27,  40, 244, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 205, 202, 252, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                             92, 123, 255, 255, 255, 255, 255, 209,  89, 172, 252,  92,  90,  90, 114, 246, 
                                            255, 255, 255, 203,  89, 150,  99,  37,  62, 188, 254, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 246, 138,  55,  30,  57, 120, 241, 255, 255, 253, 
                                            179,  78,  33,  60, 155, 251, 255, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                             57,  28, 244, 255, 255, 255, 255, 146,   1, 178, 251,  61,  52,  12,  44, 242, 
                                            255, 255, 255, 178,   0,   8,  37,  63,   7,  27, 231, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 254, 126,   2,  42,  87,  52,  17, 216, 255, 254, 154, 
                                              8,  20,  81,  36,   3, 141, 254, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                            113,   8, 204, 248, 194, 220, 255,  89,   8, 230, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0,  51, 244, 254, 119,   1, 173, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 248,  55,  30, 234, 255, 254, 210, 238, 255, 237,  20, 
                                             34, 224, 255, 240,  49,  28, 233, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                            176,   2, 162, 202,   7,  84, 245,  45,  54, 247, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 120, 255, 255, 164,   0, 143, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 251,  67,   6, 123, 203, 234, 253, 255, 255, 175,   0, 
                                             90, 195, 195, 195,  92,   3, 203, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                            217,  15, 104, 138,   0,  22, 208,  13, 100, 254, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 192,  23,   1,   2,  27, 117, 251, 255, 149,   0, 
                                              3,   4,   4,   4,   3,   2, 188, 255, 255, 248,  51,  40, 244, 255, 255, 255, 
                                            251,  42,  56,  66,  75,   9, 119,   2, 164, 255, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 246, 184, 126,  30,   2, 164, 255, 158,   0, 
                                            112, 200, 200, 200, 200, 200, 240, 255, 255, 248,  51,  39, 244, 255, 255, 255, 
                                            255, 100,   8,   9, 168,  56,  16,   8, 214, 255, 255, 255, 246,  53,  44, 242, 
                                            255, 255, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 253, 241, 254, 255, 255, 178,   1, 124, 255, 213,   4, 
                                             82, 250, 255, 255, 254, 236, 251, 255, 255, 250,  64,  28, 231, 255, 255, 255, 
                                            255, 154,   1,  21, 227, 122,   1,  26, 252, 255, 201, 160, 155,  35,  29, 153, 
                                            160, 197, 255, 178,   0, 135, 255, 255, 167,   0, 140, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 242,  67, 114, 171, 172,  71,   4, 172, 255, 252,  84, 
                                              5,  94, 172, 167, 106,  51, 236, 255, 255, 254, 121,   1,  80, 133, 152, 255, 
                                            255, 216,  17,  76, 253, 193,  17,  97, 255, 255, 125,  14,  14,  14,  14,  14, 
                                             14, 111, 255, 183,  14, 143, 255, 255, 173,  14, 147, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 245,  84,  14,   2,   2,  17, 112, 250, 255, 255, 237, 
                                             92,  14,   2,   2,  18,  86, 243, 255, 255, 255, 238,  87,  24,  14,  52, 255, 
                                            255, 251, 222, 234, 255, 250, 221, 236, 255, 255, 236, 220, 220, 220, 220, 220, 
                                            220, 234, 255, 245, 220, 239, 255, 255, 244, 220, 240, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 250, 219, 196, 195, 222, 253, 255, 255, 255, 255, 
                                            252, 219, 195, 199, 223, 252, 255, 255, 255, 255, 255, 252, 228, 220, 226, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 204, 173, 173, 173, 173, 
                                            173, 173, 173, 173, 185, 250, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 154,  93,  93,  93,  93, 
                                             93,  93,  93,  93, 115, 246, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            0,   0,   0,  37, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 196,  16, 128, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            135, 131,  32,  39, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1, 118, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1, 118, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 254, 194,  80,  34,  54, 143, 245, 
                                            255, 255, 254, 209,  92,  37,  35,  82, 177, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,  89,  86,  35,  73, 194, 254, 255, 231, 100, 144, 
                                            255, 255, 227, 100, 151, 255, 157,  89, 205, 255, 255, 255, 190,  89, 173, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 196,  16,  13,  75,  39,   2, 110, 
                                            254, 255, 236,  32,  11,  71,  81,  26,  91, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,   2,  33,  75,  12,  21, 208, 255, 218,   9,  81, 
                                            255, 255, 211,  10,  92, 255, 187,   2, 107, 254, 255, 253,  84,   5, 207, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255,  76,   3, 184, 255, 244,  46,  13, 
                                            216, 255, 182,   0, 126, 255, 255, 245, 203, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,  24, 235, 254, 171,   3,  97, 255, 218,   9,  81, 
                                            255, 255, 211,  10,  92, 255, 245,  44,  30, 234, 255, 223,  19,  63, 249, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 247,  25,  23, 253, 255, 255, 125,   1, 
                                            170, 255, 200,   3,  49, 168, 220, 245, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,  94, 254, 255, 248,  13,  32, 255, 218,   9,  81, 
                                            255, 255, 211,  10,  92, 255, 254, 134,   2, 167, 255, 147,   2, 155, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 233,  21,  51, 255, 255, 255, 156,   2, 
                                            149, 255, 250, 101,   4,   1,   7,  55, 194, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1, 114, 255, 255, 255,  26,  19, 252, 218,   9,  81, 
                                            255, 255, 211,  10,  92, 255, 255, 222,  10,  74, 254,  56,  14, 237, 255, 255, 
                                            255, 248,  59,  38, 239, 255, 255, 255, 240,  23,  37, 255, 255, 255, 142,   1, 
                                            159, 255, 255, 255, 221, 160,  85,   5,  28, 252, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1, 105, 254, 255, 254,  18,  23, 254, 218,  10,  80, 
                                            255, 255, 207,   8,  92, 255, 255, 255,  79,  11, 169,   9,  99, 255, 255, 255, 
                                            255, 252,  67,  21, 227, 255, 255, 255, 254,  45,   8, 228, 255, 254,  84,   4, 
                                            192, 255, 245, 248, 255, 255, 251,  66,   6, 238, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,  56, 252, 255, 215,   7,  69, 255, 225,  18,  66, 
                                            251, 254, 172,   1,  92, 255, 255, 255, 175,   3,  29,   5, 189, 255, 255, 255, 
                                            255, 255, 126,   0,  79, 133, 153, 252, 255, 144,   0,  68, 170, 129,   4,  50, 
                                            247, 255, 165,  62, 149, 177, 145,  16,  34, 253, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 191,   1,   1, 118, 170,  65,   2, 163, 255, 248,  53,  10, 
                                            138, 160,  34,   0,  92, 255, 255, 255, 239,  37,   0,  45, 245, 255, 255, 255, 
                                            255, 255, 242,  87,  24,  14,  57, 250, 255, 246, 109,  13,   3,   3,  54, 209, 
                                            255, 255, 185,  35,   4,   3,   3,  44, 194, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 195,  16,  51,  18,   2,  11, 115, 249, 255, 255, 182,  20, 
                                              2,   9,  77,  20, 101, 255, 255, 255, 254, 114,   0, 134, 255, 255, 255, 255, 
                                            255, 255, 255, 252, 229, 220, 226, 254, 255, 255, 253, 217, 195, 205, 243, 255, 
                                            255, 255, 254, 239, 207, 192, 204, 240, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 246, 220, 237, 221, 195, 215, 253, 255, 255, 255, 254, 224, 
                                            195, 213, 246, 222, 233, 255, 255, 255, 251,  69,   9, 221, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 248, 180, 128,   6,  86, 252, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 189, 173, 173, 173, 173, 173, 
                                            173, 173, 173, 196, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 234,   8,   3,  45, 216, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 123,  93,  93,  93,  93,  93, 
                                             93,  93,  93, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 250, 196, 199, 238, 255, 255, 255, 255, 255, 255, 
                                            0,   0,   0,  37, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 202,   2,   0,   0,  74, 253, 255, 255, 255, 255, 
                                            135, 131,  32,  39, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 230, 135, 119,  10,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 254, 194,  80,  34,  54, 143, 245, 
                                            255, 255, 254, 209,  92,  37,  35,  82, 177, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 233, 120,  45,  31,  66, 144, 249, 255, 255, 249, 156, 
                                             65,  33,  72, 180, 254, 255, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255, 196,  16,  13,  75,  39,   2, 110, 
                                            254, 255, 236,  32,  11,  71,  81,  26,  91, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 254,  81,   3,  56,  86,  41,  42, 239, 255, 252, 116,   2, 
                                             34,  82,  22,  12, 180, 254, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 255,  76,   3, 184, 255, 244,  46,  13, 
                                            216, 255, 182,   0, 126, 255, 255, 245, 203, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 232,  24,  60, 254, 255, 254, 202, 248, 255, 201,   8,  63, 
                                            241, 255, 221,  22,  56, 253, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 247,  25,  23, 253, 255, 255, 125,   1, 
                                            170, 255, 200,   3,  49, 168, 220, 245, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 241,  31,  16, 148, 211, 238, 254, 255, 255, 128,   0, 124, 
                                            195, 195, 195,  53,   4, 245, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  39, 239, 255, 255, 255, 233,  21,  51, 255, 255, 255, 156,   2, 
                                            149, 255, 250, 101,   4,   1,   7,  55, 194, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 154,  14,   0,   4,  36, 151, 253, 255, 107,   0,   3, 
                                              4,   4,   4,   2,   4, 233, 255, 255, 226,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 248,  59,  38, 239, 255, 255, 255, 240,  23,  37, 255, 255, 255, 142,   1, 
                                            159, 255, 255, 255, 221, 160,  85,   5,  28, 252, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 239, 172, 110,  17,   8, 205, 255, 115,   1, 146, 
                                            200, 200, 200, 200, 200, 250, 255, 255, 227,  20,  74, 253, 255, 255, 255, 255, 
                                            255, 252,  67,  21, 227, 255, 255, 255, 254,  45,   8, 228, 255, 254,  84,   4, 
                                            192, 255, 245, 248, 255, 255, 251,  66,   6, 238, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 250, 244, 255, 255, 254, 133,   2, 174, 255, 167,   2, 125, 
                                            253, 255, 255, 253, 235, 254, 255, 255, 235,  31,  58, 248, 255, 255, 255, 255, 
                                            255, 255, 126,   0,  79, 133, 153, 252, 255, 144,   0,  68, 170, 129,   4,  50, 
                                            247, 255, 165,  62, 149, 177, 145,  16,  34, 253, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 220,  54, 128, 175, 164,  46,  11, 211, 255, 239,  50,  12, 
                                            119, 174, 161,  88,  75, 253, 255, 255, 253,  77,   4, 101, 133, 174, 255, 255, 
                                            255, 255, 242,  87,  24,  14,  57, 250, 255, 246, 109,  13,   3,   3,  54, 209, 
                                            255, 255, 185,  35,   4,   3,   3,  44, 194, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 229,  56,   9,   3,   2,  24, 149, 253, 255, 255, 220,  68, 
                                              9,   3,   2,  25, 115, 254, 255, 255, 255, 220,  65,  19,  14,  95, 255, 255, 
                                            255, 255, 255, 252, 229, 220, 226, 254, 255, 255, 253, 217, 195, 205, 243, 255, 
                                            255, 255, 254, 239, 207, 192, 204, 240, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 246, 215, 193, 199, 229, 254, 255, 255, 255, 255, 248, 
                                            213, 193, 202, 229, 254, 255, 255, 255, 255, 255, 249, 225, 220, 233, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 189, 173, 173, 173, 173, 173, 
                                            173, 173, 173, 196, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 123,  93,  93,  93,  93,  93, 
                                             93,  93,  93, 137, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 
                                            255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255};

/*  Calculates parameters for paste image.  */
static void bb_graph_png_get_ppi(int t_w, int t_h, char *image, int w, int h, int pen_x, int pen_y, struct bb_paste_image *ppi);

/*  Gets line.  */
static inline void bb_graph_png_get_line(unsigned char *data, int w, int h, int cx1, int cy1, int cx2, int cy2);

/*  Gets value of sample.  */
static inline float bb_graph_png_sample(float px, float py, float ax, float ay, float bax, float bay);

/*  Draws figure.  */
static void bb_graph_png_draw_figure(unsigned char *text, int text_w, int text_h, char *image, unsigned int width, unsigned int height, 
    int pen_x, int pen_y, const unsigned char text_color[3]);

/* Sets error data. */
static void bb_graph_png_set_error(int err_code, struct bb_error *perr);

int bb_graph_png_init(struct bb_graph_png **ppgp, int w, int h, struct bb_error *perr)
{
    const char *pt;
    char *p, *p2, *p3;
    int i, err_code;

    err_code = 0;

    if (!ppgp)
        err_code = 3;
    else if ((w <= 0) || (h <= 0))
        err_code = 4;
    else
    {
        *ppgp = (struct bb_graph_png *) calloc(1, sizeof(struct bb_graph_png));
        if (!*ppgp)
            err_code = 1;
        else
        {
            (*ppgp)->png = libattopng_new(w, h, PNG_RGB);
            if (!(*ppgp)->png)
                err_code = 5;
            else
            {
                (*ppgp)->r = (char *) calloc(BB_GL_WH * BB_GL_N, 1);
                if (!(*ppgp)->r)
                    err_code = 1;
                else
                {
                    for (i = 0, pt = (const char *) BB_GL; i < BB_GL_N; ++i)
                        for (p = (*ppgp)->r + i * BB_GL_H * BB_GL_W, p2 = p + BB_GL_H; p < p2; ++p)
                            for (p3 = p + BB_GL_H * (BB_GL_W - 1); p3 >= p; p3 -= BB_GL_H)
                                *p3 = *pt++;

                    (*ppgp)->w = w;
                    (*ppgp)->h = h;
                    (*ppgp)->wh = w * h;

                    memset((*ppgp)->png->data, 0xff, (*ppgp)->wh * BB_GRAPH_PNG_BP);        // White sheet.
                }
            }
        }
    }

    if (err_code)
        bb_graph_png_free(ppgp);

    if (err_code && perr)
        bb_graph_png_set_error(err_code, perr);
    return err_code;
}

int bb_graph_png_draw_rect(struct bb_graph_png *pgp, int x, int y, int w, int h, const unsigned char color[3], struct bb_error *perr)
{
    struct bb_paste_image pid = {0};
    char *p, *p2;
    int err_code;

    err_code = 0;

    if (!pgp)
        err_code = 3;
    else if (!w || !h)
        err_code = 7;
    else
    {
        bb_graph_png_get_ppi(w, h, pgp->png->data, pgp->w, pgp->h, x, y, &pid);

        for (p = pid.i_start; p < pid.i_stop; p += pid.i_step)
            for (p2 = p + pid.i_string; p < p2; ++p)
            {
                *p++ = (char) *color;
                *p++ = (char) *(color + 1);
                *p++ = (char) *(color + 2);
            }
    }

    if (err_code && perr)
        bb_graph_png_set_error(err_code, perr);
    return err_code;
}

int bb_graph_png_draw_line(struct bb_graph_png *pgp, int x1, int y1, int x2, int y2, const unsigned char color[3], struct bb_error *perr)
{
    size_t n;
    int w, h, cx1, cx2, cy1, cy2, err_code;

    err_code = 0;

    if (x2 < x1)
    {
        h = x2;
        x2 = x1;
        x1 = h;

        h = y2;
        y2 = y1;
        y1 = h;
    }

    if (x1 == x2)
    {
        if (y1 > y2)
            err_code = bb_graph_png_draw_rect(pgp, x2 - BB_GRAPH_PNG_LW / 2, y2, BB_GRAPH_PNG_LW, (y1 - y2), color, perr);
        else if (y2 > y1)
            err_code = bb_graph_png_draw_rect(pgp, x1 - BB_GRAPH_PNG_LW / 2, y1, BB_GRAPH_PNG_LW, (y2 - y1), color, perr);
        else
            err_code = bb_graph_png_draw_rect(pgp, x1 - BB_GRAPH_PNG_LW / 2, y1 - BB_GRAPH_PNG_LW / 2, 
                BB_GRAPH_PNG_LW, BB_GRAPH_PNG_LW, color, perr);
    }
    else if (y1 == y2)
        err_code = bb_graph_png_draw_rect(pgp, x1, y1 - BB_GRAPH_PNG_LW / 2, (x2 - x1), BB_GRAPH_PNG_LW, color, perr);
    else
    {
        w = x2 - x1;
        h = y2 - y1;
        if (h < 0)
            h = -h;

        n = (size_t) (w + 2 * BB_GRAPH_PNG_LP) * (size_t) (h + 2 * BB_GRAPH_PNG_LP) * BB_GRAPH_PNG_BP;
        if (n > pgp->buf_size)
        {
            if (pgp->buf)
                free(pgp->buf);
            pgp->buf = (unsigned char *) calloc(n, 1);
            if (!pgp->buf)
            {
                pgp->buf_size = 0;
                err_code = 1;
            }
            else
                pgp->buf_size = n;
        }
        else
            memset(pgp->buf, 0, pgp->buf_size);

        if (!err_code)
        {
            cx1 = BB_GRAPH_PNG_LP;
            cx2 = BB_GRAPH_PNG_LP + w;
            x1 -= BB_GRAPH_PNG_LP;

            if (y1 < y2)
            {
                cy1 = BB_GRAPH_PNG_LP;
                cy2 = BB_GRAPH_PNG_LP + h;
                y1 -= BB_GRAPH_PNG_LP;
            }
            else
            {
                cy2 = BB_GRAPH_PNG_LP;
                cy1 = BB_GRAPH_PNG_LP + h;
                y1 -= BB_GRAPH_PNG_LP + h;
            }

            bb_graph_png_get_line(pgp->buf, (w + 2 * BB_GRAPH_PNG_LP), (h + 2 * BB_GRAPH_PNG_LP), cx1, cy1, cx2, cy2);

            bb_graph_png_draw_figure(pgp->buf, (w + 2 * BB_GRAPH_PNG_LP), (h + 2 * BB_GRAPH_PNG_LP), pgp->png->data, pgp->w, pgp->h, 
                x1, y1, color);
        }
    }

    if (err_code && perr)
        bb_graph_png_set_error(err_code, perr);
    return err_code;
}

void bb_graph_png_draw_point(struct bb_graph_png *pgp, int x, int y, const unsigned char color[3], struct bb_error *perr)
{
    bb_graph_png_draw_figure(BB_GP, BB_GP_W, BB_GP_H, pgp->png->data, pgp->w, pgp->h, (x - BB_GP_W / 2), (y - BB_GP_W / 2), color);
    //bb_graph_png_draw_figure(BB_GP, BB_GP_W, BB_GP_H, pgp->png->data, pgp->w, pgp->h, x, y, color);
}

int bb_graph_png_draw_legend(struct bb_graph_png *pgp, int x, int y, struct bb_error *perr)
{
    unsigned char color[3] = {0, 0, 0};
    int err_code;

    //err_code = 0;

    err_code = bb_graph_png_draw_rect(pgp, x, y, BB_GT_RW, BB_GT_RH, BB_G_WB_COLOR, perr);
    if (!err_code)
    {
        x += BB_GT_RW + BB_GT_P1;
        bb_graph_png_draw_figure(BB_GT + (BB_GT_WB * BB_GT_WH), BB_GT_W, BB_GT_H, pgp->png->data, pgp->w, pgp->h, x, y, color);

        x += BB_GT_W + BB_GT_P2;

        err_code = bb_graph_png_draw_rect(pgp, x, y, BB_GT_RW, BB_GT_RH, BB_G_WS_COLOR, perr);
        if (!err_code)
        {
            x += BB_GT_RW + BB_GT_P1;
            bb_graph_png_draw_figure(BB_GT + (BB_GT_WS * BB_GT_WH), BB_GT_W, BB_GT_H, pgp->png->data, pgp->w, pgp->h, x, y, color);

            x += BB_GT_W + BB_GT_P2;

            err_code = bb_graph_png_draw_rect(pgp, x, y, BB_GT_RW, BB_GT_RH, BB_G_LB_COLOR, perr);
            if (!err_code)
            {
                x += BB_GT_RW + BB_GT_P1;
                bb_graph_png_draw_figure(BB_GT + (BB_GT_LB * BB_GT_WH), BB_GT_W, BB_GT_H, pgp->png->data, pgp->w, pgp->h, x, y, color);

                x += BB_GT_W + BB_GT_P2;

                err_code = bb_graph_png_draw_rect(pgp, x, y, BB_GT_RW, BB_GT_RH, BB_G_LS_COLOR, perr);
                if (!err_code)
                {
                    x += BB_GT_RW + BB_GT_P1;
                    bb_graph_png_draw_figure(BB_GT + (BB_GT_LS * BB_GT_WH), BB_GT_W, BB_GT_H, pgp->png->data, pgp->w, pgp->h, x, y, color);
                }
            }
        }
    }

    if (err_code && perr)
        bb_graph_png_set_error(err_code, perr);
    return err_code;
}

int bb_graph_png_write_text(struct bb_graph_png *pgp, int x, int y, const char *text, size_t text_len, const unsigned char color[3], 
    _Bool rotate, struct bb_error *perr)
{
    const char *p, *p2;
    size_t n;
    int err_code;

    err_code = 0;

    //puts("---");
    if (!pgp || !text)
        err_code = 3;
    else
    {
        for (p = text, p2 = p + text_len; (p < p2) && !err_code; ++p)
        {
            if (((*p < 48) || (*p > 57)) &&         // 0-9
                (*p != 37) &&                       // %
                (*p != 44) &&                       // ,
                (*p != 45) &&                       // -
                (*p != 46))                         // .
            {
                err_code = 9;
                //printf("%zu\n", ((size_t) *p) & 0xff);
                //printf("%zu\n", (p - text));
            }
            else
            {
                n = ((size_t) *p) & 0xff;
                if (37 == n)
                    n = 12;
                else if ((44 == n) || (46 == n))
                    n = 10;
                else if (45 == n)
                    n = 11;
                else
                    n -= 48;
                //printf("%zu\n", n);

                if (!rotate)
                {
                    bb_graph_png_draw_figure(BB_GL + n * BB_GL_WH, BB_GL_W, BB_GL_H, 
                        pgp->png->data, pgp->w, pgp->h, x, y, color);
                    x += BB_GL_W;
                }
                else
                {
                    bb_graph_png_draw_figure((unsigned char *) pgp->r + n * BB_GL_WH, BB_GL_H, BB_GL_W, 
                        pgp->png->data, pgp->w, pgp->h, x, y - BB_GL_W, color);
                    y -= BB_GL_W;
                }
            }
        }
    }
    //puts("---");

    if (err_code && perr)
        bb_graph_png_set_error(err_code, perr);
    return err_code;
}

int bb_graph_png_save(struct bb_graph_png *pgp, const char *file_name, struct bb_error *perr)
{
    return ((!pgp || !file_name) ? 3 : (libattopng_save(pgp->png, file_name) ? 10 : 0));
}

void bb_graph_png_free(struct bb_graph_png **ppgp)
{
    if (ppgp && *ppgp)
    {
        if ((*ppgp)->png)
            libattopng_destroy((*ppgp)->png);
        if ((*ppgp)->r)
            free((*ppgp)->r);
        if ((*ppgp)->buf)
            free((*ppgp)->buf);
        free(*ppgp);
        *ppgp = NULL;
    }
}

const char * bb_graph_png_error_message(int err_code)
{
    static const char *BB_GRAPH_PNG_ERRS[BB_GRAPH_PNG_ERRS_N] = {   "ОК",                                                       //  0
                                                                    "Ошибка выделения памяти",                                  //  1
                                                                    "Неизвестная ошибка",                                       //  2
                                                                    "Пустой указатель",                                         //  3
                                                                    "Некорректное значение ширины или высоты изображения.",     //  4
                                                                    "Ошибка инициализации дескриптора png",                     //  5
                                                                    "Ошибка при установке палитры png",                         //  6
                                                                    "Некорректное значение ширины или высоты прямоугольника.",  //  7
                                                                    "Некорректное значение номера цвета.",                      //  8
                                                                    "Некорректный символ в тексте",                             //  9
                                                                    "Ошибка при сохранении png-файла",                          // 10
    };

    if ((err_code < 0) || (err_code >= BB_GRAPH_PNG_ERRS_N))
        err_code = 2;

    return *(BB_GRAPH_PNG_ERRS + err_code);
}

static void bb_graph_png_get_ppi(int t_w, int t_h, char *image, int w, int h, int pen_x, int pen_y, struct bb_paste_image *ppi)
{
    unsigned int wbp;

    wbp = w * BB_GRAPH_PNG_BP;

    if (pen_x < 0)
    {
        if (pen_y < 0)
        {
            ppi->i_start = image;
            ppi->to_start = -(pen_y * t_w + pen_x);
        }
        else
        {
            ppi->i_start = image + (pen_y * wbp);
            ppi->to_start = -pen_x;
        }

        ppi->i_string = (t_w + pen_x) * BB_GRAPH_PNG_BP;
        if (ppi->i_string > wbp)
            ppi->i_string = wbp;
    }
    else
    {
        if (pen_y < 0)
        {
            ppi->i_start = image + pen_x * BB_GRAPH_PNG_BP;
            ppi->to_start = -pen_y * t_w;
        }
        else
        {
            ppi->i_start = image + pen_y * wbp + pen_x * BB_GRAPH_PNG_BP;
            ppi->to_start = 0;
        }

        ppi->i_string = t_w * BB_GRAPH_PNG_BP;
        if (ppi->i_string > wbp - pen_x * BB_GRAPH_PNG_BP)
            ppi->i_string = wbp - pen_x * BB_GRAPH_PNG_BP;
    }

    ppi->i_step = wbp - ppi->i_string;
    ppi->t_step = t_w - ppi->i_string / BB_GRAPH_PNG_BP;
    ppi->i_stop = (t_h + pen_y > h) ? image + wbp * h : image + wbp * (t_h + pen_y);
}

static inline void bb_graph_png_get_line(unsigned char *data, int w, int h, int cx1, int cy1, int cx2, int cy2)
{
    float sum;
    unsigned char *p;
    int x, y, i, j;

    for (p = data, y = 0; y < h; y++)
        for (x = 0; x < w; ++x)
        {
            sum = 0.0;
            for (j = -BB_GRAPH_PNG_SH / 2; j <= BB_GRAPH_PNG_SH / 2; ++j)
                for (i = -BB_GRAPH_PNG_SW / 2; i <= BB_GRAPH_PNG_SW / 2; ++i)
                    sum += bb_graph_png_sample( x + ((float) i / (float) BB_GRAPH_PNG_SW), 
                                                y + ((float) j / (float) BB_GRAPH_PNG_SH), 
                                                (float) cx1, 
                                                (float) cy1, 
                                                (float) (cx2 - cx1), 
                                                (float) (cy2 - cy1));

            *p++ = (unsigned char) ((1.0f - sum / (float) (BB_GRAPH_PNG_SW * BB_GRAPH_PNG_SH)) * (float) 255);
        }
}

static inline float bb_graph_png_sample(float px, float py, float ax, float ay, float bax, float bay)
{
    float pax, pay, h, dx, dy;

    pax = px - ax;
    pay = py - ay;
    h = fmaxf(fminf((pax * bax + pay * bay) / (bax * bax + bay * bay), 1.0f), 0.0f);
    dx = pax - bax * h;
    dy = pay - bay * h;

    return ((dx * dx + dy * dy) < BB_GRAPH_PNG_LINE_WW) ? 1.0f : 0.0f;
}

static void bb_graph_png_draw_figure(unsigned char *text, int text_w, int text_h, char *image, unsigned int width, unsigned int height, 
    int pen_x, int pen_y, const unsigned char text_color[3])
{
    struct bb_paste_image pid = {0};
    double k4, k5;
    unsigned char *p, *t_start, *i_string_end, tc0, tc1, tc2;

    if ((-pen_x < text_w) && 
        (-pen_y < text_h) && 
        ((pen_x <= 0) || ((unsigned int) pen_x < width)) &&
        ((pen_y <= 0) || ((unsigned int) pen_y < height)))
    {
        bb_graph_png_get_ppi(text_w, text_h, image, width, height, pen_x, pen_y, &pid);

        t_start = text + pid.to_start;

        tc0 = *text_color;
        tc1 = *(text_color + 1);
        tc2 = *(text_color + 2);

        for (p = (unsigned char *) pid.i_start; p < (unsigned char *) pid.i_stop; p += pid.i_step, t_start += pid.t_step)
            for (i_string_end = p + pid.i_string; p < i_string_end; ++t_start, ++p)
            {
                k5 = (double) (255 - *t_start) / (double) 255;
                k4 = (double) 1 - k5;

                *p = k4 * *p + k5 * tc0;
                ++p;
                *p = k4 * *p + k5 * tc1;
                ++p;
                *p = k4 * *p + k5 * tc2;
                ++p;
            }

    }
}
/*
static inline float bb_graph_png_sample(float px, float py, float ax, float ay, float bax, float bay)
{
    float pax, pay, h, dx, dy;

    pax = px - ax;
    pay = py - ay;
    h = fmaxf(fminf((pax * bax + pay * bay) / (bax * bax + bay * bay), 1.0f), 0.0f);
    dx = pax - bax * h;
    dy = pay - bay * h;

    return ((dx * dx + dy * dy) < BB_GRAPH_PNG_LINE_WW) ? 1.0f : 0.0f;
}

static void bb_graph_png_draw_figure(unsigned char *text, int text_w, int text_h, char *image, unsigned int width, unsigned int height, 
    int pen_x, int pen_y, const unsigned char text_color[3])
{
    struct bb_paste_image pid = {0};
    char *p, *t_start, *i_string_end;
    double k4, k5, tc0, tc1, tc2;

    if ((-pen_x < text_w) && 
        (-pen_y < text_h) && 
        ((pen_x <= 0) || ((unsigned int) pen_x < width)) &&
        ((pen_y <= 0) || ((unsigned int) pen_y < height)))
    {
        bb_graph_png_get_ppi(text_w, text_h, image, width, height, pen_x, pen_y, &pid);

        t_start = (char *) text + pid.to_start;

        tc0 = (double) *text_color;
        tc1 = (double) *(text_color + 1);
        tc2 = (double) *(text_color + 2);

        for (p = pid.i_start; p < pid.i_stop; p += pid.i_step, t_start += pid.t_step)
            for (i_string_end = p + pid.i_string; p < i_string_end; ++t_start, ++p)
            {
                //k5 = (double) (255 - *t_start) / (double) 255;
                k5 = (double) (255 - *t_start) / (double) 255;
                k4 = (double) 1 - k5;

                *p = k4 * *p + k5 * tc0;
                ++p;
                *p = k4 * *p + k5 * tc1;
                ++p;
                *p = k4 * *p + k5 * tc2;
                ++p;
            }

    }
}
*/
static void bb_graph_png_set_error(int err_code, struct bb_error *perr)
{
    perr->err_code = err_code;
    perr->err_str = bb_graph_png_error_message(err_code);
}